<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<link type="text/css" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/pusher/4.3.1/pusher.min.js"></script>

<h1>Events</h1>

<div id='mynetwork' style="height:800px"></div>

<script type="text/javascript">
  retrieveEvents().then(events => showEventBubbles(events));
  listenForPusherEvents();

  function listenForPusherEvents() {
    var pusher = new Pusher('app_key', {
      wsHost: 'localhost',
      wsPort: 8080,
      enabledTransports: ['ws', 'flash'],
      disabledTransports: ['flash']
    });

    const channel = pusher.subscribe('channel');

    channel.bind('event', function ({ id, message, prior_event_id }) {
      nodes.add({ id: id, label: message });
      edges.add({ from: id, to: prior_event_id });
    });
  }

  var nodes;
  var edges;
  function retrieveEvents() {
    var promise = new Promise((resolve, reject) => {

      var xhr = new XMLHttpRequest();
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          var events = JSON.parse(xhr.response);
          resolve(events);
        } else {
          alert('Request failed, see console');
          console.error('Request failed', xhr);
          reject();
        }
      };

      xhr.open('GET', '/events/all');
      xhr.send();
    });

    return promise;
  }

  function showEventBubbles(events) {
    var edgesData = [];
    nodes = new vis.DataSet(events.map(thisEvent => {
      edgesData.push({ from: thisEvent.id, to: thisEvent.prior_event_id });

      return {
        id: thisEvent.id,
        label: thisEvent.message,
        priorEventId: thisEvent.prior_event_id
      };
    }));

    edges = new vis.DataSet(edgesData);

    var container = document.getElementById('mynetwork');
    var data = {
      nodes: nodes,
      edges: edges
    };
    var options = {};
    var network = new vis.Network(container, data, options);
  }
</script>
